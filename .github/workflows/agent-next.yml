name: Agent Next Cycle

on:
  push:
    branches:
      - main
    paths:
      - 'agent/state/**'

permissions:
  contents: read

jobs:
  trigger-next:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Check if should continue
        id: check
        run: |
          # Only trigger for agent PRs
          COMMIT_MSG=$(git log -1 --pretty=%B)
          if [[ "$COMMIT_MSG" != *"[Agent]"* ]]; then
            echo "continue=false" >> $GITHUB_OUTPUT
            exit 0
          fi

          # Read config
          MAX_PRS=$(grep -E "^\| MAX_PRS_PER_DAY" agent/config.md | awk -F'|' '{print $3}' | tr -d ' ')
          MAX_PRS=${MAX_PRS:-2}

          # Check PR count
          TODAY=$(date -u +%Y-%m-%d)
          CURRENT_COUNT=0

          if [ -f agent/state/current.md ]; then
            LAST_UPDATE=$(grep -E "^Last Updated:" agent/state/current.md | head -1 || echo "")
            if [[ "$LAST_UPDATE" == *"$TODAY"* ]]; then
              PR_LINE=$(grep -E "^PR Count Today:" agent/state/current.md || echo "")
              CURRENT_COUNT=$(echo "$PR_LINE" | grep -oE "[0-9]+/" | tr -d '/' || echo "0")
            fi
          fi

          if [ "$CURRENT_COUNT" -ge "$MAX_PRS" ]; then
            echo "continue=false" >> $GITHUB_OUTPUT
            echo "Daily limit reached. Next cycle at 8 AM UTC."
          else
            echo "continue=true" >> $GITHUB_OUTPUT
          fi

      - name: Trigger next work cycle
        if: steps.check.outputs.continue == 'true'
        run: |
          curl -X POST \
            -H "Accept: application/vnd.github.v3+json" \
            -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            https://api.github.com/repos/${{ github.repository }}/dispatches \
            -d '{"event_type": "agent-next-cycle"}'
