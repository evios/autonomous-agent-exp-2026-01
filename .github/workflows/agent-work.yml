name: Agent Work Session

on:
  schedule:
    - cron: '0 8 * * *'   # Daily start at 8 AM UTC
  workflow_dispatch:       # Manual trigger for testing
  repository_dispatch:     # Triggered by merge to continue cycle
    types: [agent-next-cycle]

jobs:
  work:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
      issues: write
      id-token: write
    steps:
      - uses: actions/checkout@v4

      - name: Read config and check limits
        id: check
        run: |
          # Read MAX_PRS_PER_DAY from boundaries.md
          MAX_PRS=$(grep -E "^\| MAX_PRS_PER_DAY" agent/config.md | awk -F'|' '{print $3}' | tr -d ' ')
          MAX_PRS=${MAX_PRS:-2}
          echo "max_prs_per_day=$MAX_PRS" >> $GITHUB_OUTPUT

          # Check PR count (default 0 if file missing)
          TODAY=$(date -u +%Y-%m-%d)
          CURRENT_COUNT=0

          if [ -f agent/state/current.md ]; then
            LAST_UPDATE=$(grep -E "^Last Updated:" agent/state/current.md | head -1 || echo "")
            if [[ "$LAST_UPDATE" == *"$TODAY"* ]]; then
              PR_LINE=$(grep -E "^PR Count Today:" agent/state/current.md || echo "")
              CURRENT_COUNT=$(echo "$PR_LINE" | grep -oE "[0-9]+/" | tr -d '/' || echo "0")
            fi
          fi

          echo "current_count=$CURRENT_COUNT" >> $GITHUB_OUTPUT

          if [ "$CURRENT_COUNT" -ge "$MAX_PRS" ]; then
            echo "skip=true" >> $GITHUB_OUTPUT
            echo "Daily limit reached ($CURRENT_COUNT/$MAX_PRS). Skipping."
          else
            echo "skip=false" >> $GITHUB_OUTPUT
            echo "PR count: $CURRENT_COUNT/$MAX_PRS. Proceeding."
          fi

      - name: Agent Work Session
        if: steps.check.outputs.skip != 'true'
        uses: anthropics/claude-code-action@v1
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN || secrets.ANTHROPIC_API_KEY }}
          prompt: |
            You are an autonomous agent. Read CLAUDE.md for operating instructions and GOALS.md for objectives.

            Follow the PDCA cycle and do ONE meaningful unit of work.

            CRITICAL RULES:
            1. ALWAYS create a PR if you modified/created ANY files - your work is LOST if you don't commit and push
            2. PR title MUST start with "[Agent]"
            3. Your PR count today: ${{ steps.check.outputs.current_count }}/${{ steps.check.outputs.max_prs_per_day }}
            4. After creating PR, update agent/state/current.md with incremented "PR Count Today: N/M"
            5. Do NOT use `gh pr list` to count PRs - only trust the state file

            Steps to create PR:
            ```bash
            git checkout -b agent/$(date +%m-%d-%Y)-description
            git add -A
            git commit -m "[Agent] Your commit message"
            git push -u origin HEAD
            gh pr create --title "[Agent] Your PR title" --body "Your description"
            ```

            Follow boundaries in agent/config.md.
          claude_args: |
            --model ${{ vars.CLAUDE_MODEL || 'claude-opus-4-5-20251101' }}
            --max-turns 20
            --allowed-tools "Bash(git:*),Bash(gh issue:*),Bash(gh pr:*),Bash(gh gist:*),Read,Write,Edit,Glob,Grep,WebFetch,WebSearch"