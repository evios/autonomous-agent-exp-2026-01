name: Agent Work Session

on:
  schedule:
    - cron: '0 13,15,17,19,21,23 * * *'  # Work: every 2h, 08:00-18:00 US Eastern (UTC-5)
    - cron: '0 1,3 * * *'                # Work: every 2h, 20:00-22:00 US Eastern (UTC-5)
    - cron: '0 20 * * 0'        # Weekly retro: Sunday 15:00 US Eastern (UTC-5)
  workflow_dispatch:       # Manual trigger or chained via agent-trigger.yml
    inputs:
      mode:
        description: 'Session mode'
        required: false
        default: 'work'
        type: choice
        options:
          - work
          - retro
  # NOTE: push trigger not supported by claude-code-action. The action only supports specific 
  #     event types (pull_request, issue_comment, workflow_dispatch, schedule, etc.) - not push. 
  # Use workflow_dispatch or schedule for chaining sessions
  #push:                    # Triggered when state changes on main
  #  branches:
  #    - main
  #  paths:
  #    - 'agent/state/**'

# Security: All actions pinned to commit SHAs to prevent tag hijacking attacks.
# A compromised tag (e.g. @v1) could inject malicious code into workflows.
# Update SHAs manually when upgrading action versions.

# Prevent parallel runs - only one agent session at a time
concurrency:
  group: agent-work
  cancel-in-progress: false  # Let running job finish, queue the next

jobs:
  work:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
      issues: write
      id-token: write
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6

      - name: Fetch X metrics
        id: metrics
        env:
          X_API_KEY: ${{ secrets.X_API_KEY }}
          X_API_KEY_SECRET: ${{ secrets.X_API_KEY_SECRET }}
          X_ACCESS_TOKEN: ${{ secrets.X_ACCESS_TOKEN }}
          X_ACCESS_TOKEN_SECRET: ${{ secrets.X_ACCESS_TOKEN_SECRET }}
        run: |
          pip install -q requests-oauthlib
          METRICS=$(python3 agent/integrations/x/metrics.py --compact 2>&1) || METRICS="metrics unavailable"
          echo "summary=${METRICS%%$'\n'*}" >> $GITHUB_OUTPUT
          echo "X metrics: $METRICS"

      - name: Read config and check limits
        id: check
        env:
          MAX_PRS_VAR: ${{ vars.MAX_PRS_PER_DAY }}
          INPUT_MODE: ${{ inputs.mode }}
          EVENT_SCHEDULE: ${{ github.event.schedule }}
        run: .github/scripts/check-session.sh

      - name: Agent Work Session
        if: steps.check.outputs.skip != 'true' && steps.check.outputs.mode == 'work'
        uses: anthropics/claude-code-action@1ab477dde68ac9be1126aa7775191f02c3070b07 # v1
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN || secrets.ANTHROPIC_API_KEY }}
          allowed_bots: "github-actions[bot]"
          prompt: |
            You are an autonomous agent. Read CLAUDE.md for operating instructions and GOALS.md for objectives.

            Follow the PDCA cycle and do ONE meaningful unit of work.
            Use the Write tool to create files — do NOT use bash redirects (cat >, echo >, printf >).

            Today's date: ${{ steps.check.outputs.today }}
            X metrics: ${{ steps.metrics.outputs.summary }}

            CRITICAL RULES:
            1. ALWAYS create a PR if you modified/created ANY files - your work is LOST if you don't commit and push
            2. PR title MUST start with "[Agent]"
            3. Your PR count today: ${{ steps.check.outputs.current_count }}/${{ steps.check.outputs.max_prs_per_day }}
            4. After creating PR, update agent/state/current.md with incremented "PR Count Today: N/M"
            5. Do NOT use `gh pr list` to count PRs - only trust the state file
            6. STOP IMMEDIATELY after creating your PR. Do not continue working. Your session is done.

            CONTENT TARGET: Create 5-8 content pieces per session (mix of tweets, replies, threads).

            TURN BUDGET (you have 25 turns — finish early, do not use all of them):
            - Turns 1-8: read state, research, discover reply targets.
            - Turns 8-15: create output files (tweets, replies, research docs). Aim for 5-8 pieces.
            - Turns 15-20: commit and create your PR.
            - By turn 20: you MUST have created a PR. No exceptions.
            - If you have nothing to commit by turn 15, commit what you have — partial work > lost work.

            Steps to create PR:
            ```bash
            git checkout -b agent/$(date +%m-%d-%Y)-description
            git add -A
            git commit -m "[Agent] Your commit message"
            git push -u origin HEAD
            gh pr create --title "[Agent] Your PR title" --body "Your description"
            ```
            After `gh pr create` succeeds, STOP. Do not do anything else.

            Follow boundaries in agent/config.md.
          claude_args: |
            --model ${{ vars.CLAUDE_WORK_MODEL || 'claude-sonnet-4-5-20250929' }}
            --max-turns 50
            --allowed-tools "Bash(git:*),Bash(gh api:*),Bash(gh issue:*),Bash(gh pr:*),Bash(gh gist:*),Bash(gh run:*),Bash(gh variable:*),Bash(mkdir:*),Bash(mv:*),Bash(ls:*),Bash(cp:*),Bash(touch:*),Bash(cat:*),Bash(head:*),Bash(tail:*),Bash(wc:*),Bash(grep:*),Bash(find:*),Bash(sort:*),Bash(diff:*),Bash(date:*),Bash(echo:*),Bash(printf:*),Bash(cut:*),Bash(tr:*),Bash(uniq:*),Bash(xargs:*),Bash(tee:*),Bash(sed:*),Bash(awk:*),Bash(jq:*),Bash(basename:*),Bash(dirname:*),Bash(realpath:*),Bash(stat:*),Bash(lsof:*),Read,Write,Edit,Glob,Grep,WebFetch,WebSearch"

      - name: Agent Weekly Retrospective
        if: steps.check.outputs.skip != 'true' && steps.check.outputs.mode == 'retro'
        uses: anthropics/claude-code-action@1ab477dde68ac9be1126aa7775191f02c3070b07 # v1
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN || secrets.ANTHROPIC_API_KEY }}
          allowed_bots: "github-actions[bot]"
          prompt: |
            You are an autonomous agent running a WEEKLY RETROSPECTIVE. Read CLAUDE.md (especially the "Weekly Retrospective" section) for the full protocol.

            Today's date: ${{ steps.check.outputs.today }}
            X metrics: ${{ steps.metrics.outputs.summary }}

            ## Your Mission
            Perform a deep weekly analysis across all sessions since the last retro. The PRIMARY deliverable is evidence-based skill updates.

            ## Steps
            1. **Gather data**: List all merged PRs since last retro (`gh pr list --state merged --limit 20`). Read their descriptions and key diffs. Read current state, goals, skills, and learnings.
            2. **Analyze patterns**: What themes recur across sessions? What content performed well/poorly? What's missing from the agent's approach?
            3. **Goal gap analysis**: Compare current metrics to targets (from GOALS.md). Calculate velocity and updated ETA. Is the current strategy on track?
            4. **Skill audit**: Read all files in `.claude/skills/`. Are the skills producing good behavior? What's outdated, wrong, or missing?
            5. **Update skills**: This is the HIGHEST-LEVERAGE output. Make evidence-based changes to skill files. Follow the "Skill Development (High Bar)" protocol in CLAUDE.md - document reasoning and evidence.
            6. **Write retro doc**: Save full analysis to `agent/memory/learnings/retro-weekly-${{ steps.check.outputs.today }}.md`
            7. **Update state**: Update `agent/state/current.md` with retro findings and next week's priorities.
            8. **Create PR**: Commit all changes and create a PR.

            CRITICAL RULES:
            1. ALWAYS create a PR - your work is LOST if you don't commit and push
            2. PR title MUST start with "[Agent] Weekly retro:"
            3. Focus on SKILL UPDATES as the main deliverable - skills are how you improve
            4. Be honest and specific in analysis - vague retros are useless
            5. STOP IMMEDIATELY after creating your PR. Do not continue working. Your session is done.

            TURN BUDGET (you have 50 turns — finish early, do not use all of them):
            - Turns 1-20: research, read PRs, gather data, analyze patterns.
            - Turns 20-35: write retro doc and skill updates.
            - Turns 35-40: commit and create your PR.
            - By turn 40: you MUST have created a PR. No exceptions.
            - If you have nothing to commit by turn 35, commit what you have — partial work > lost work.

            Steps to create PR:
            ```bash
            git checkout -b agent/${{ steps.check.outputs.today }}-weekly-retro
            git add -A
            git commit -m "[Agent] Weekly retrospective ${{ steps.check.outputs.today }}"
            git push -u origin HEAD
            gh pr create --title "[Agent] Weekly retro: <summary>" --body "Your description"
            ```
            After `gh pr create` succeeds, STOP. Do not do anything else.

            Follow boundaries in agent/config.md.
          claude_args: |
            --model ${{ vars.CLAUDE_RETRO_MODEL || 'claude-opus-4-6' }}
            --max-turns 80
            --allowed-tools "Bash(git:*),Bash(gh api:*),Bash(gh issue:*),Bash(gh pr:*),Bash(gh gist:*),Bash(gh run:*),Bash(gh variable:*),Bash(mkdir:*),Bash(mv:*),Bash(ls:*),Bash(cp:*),Bash(touch:*),Bash(cat:*),Bash(head:*),Bash(tail:*),Bash(wc:*),Bash(grep:*),Bash(find:*),Bash(sort:*),Bash(diff:*),Bash(date:*),Bash(echo:*),Bash(printf:*),Bash(cut:*),Bash(tr:*),Bash(uniq:*),Bash(xargs:*),Bash(tee:*),Bash(sed:*),Bash(awk:*),Bash(jq:*),Bash(basename:*),Bash(dirname:*),Bash(realpath:*),Bash(stat:*),Bash(lsof:*),Read,Write,Edit,Glob,Grep,WebFetch,WebSearch"

      - name: Rescue unpushed work
        if: failure()
        env:
          GH_TOKEN: ${{ github.token }}
        run: .github/scripts/rescue-work.sh