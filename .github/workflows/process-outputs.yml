name: Process Outputs

# Security: All actions pinned to commit SHAs to prevent tag hijacking attacks.
# Update SHAs manually when upgrading action versions.
#
# Posts pending content via integrations
# Runs every 2 hours, posts up to X_TWEETS_PER_RUN + X_REPLIES_PER_RUN per run (Free API tier: 17 posts/24hrs)

on:
  schedule:
    - cron: '0 11,13,15,17,19,21,23 * * *'  # Every 2h, 06:00-18:00 US Eastern (UTC-5)
    - cron: '0 1,3,5 * * *'                 # Every 2h, 20:00-00:00 US Eastern (UTC-5)
  workflow_dispatch:

jobs:
  process:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
    env:
      X_API_KEY: ${{ secrets.X_API_KEY }}
      X_API_KEY_SECRET: ${{ secrets.X_API_KEY_SECRET }}
      X_ACCESS_TOKEN: ${{ secrets.X_ACCESS_TOKEN }}
      X_ACCESS_TOKEN_SECRET: ${{ secrets.X_ACCESS_TOKEN_SECRET }}
      X_MAX_TWEET_LENGTH: ${{ vars.X_MAX_TWEET_LENGTH || '25000' }}
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6

      - name: Post to X
        run: |
          pip install -q requests-oauthlib
          python agent/integrations/x/x.py --post --limit-tweets ${{ vars.X_TWEETS_PER_RUN || '1' }} --limit-replies ${{ vars.X_REPLIES_PER_RUN || '1' }}

      - name: Post to Bluesky
        if: ${{ !cancelled() }}
        env:
          BLUESKY_HANDLE: ${{ vars.BLUESKY_HANDLE }}
          BLUESKY_APP_PASSWORD: ${{ secrets.BLUESKY_APP_PASSWORD }}
        run: |
          if [ -z "$BLUESKY_HANDLE" ]; then
            echo "Bluesky credentials not configured, skipping"
            exit 0
          fi
          pip install -q atproto
          python agent/integrations/bluesky/bluesky.py --post \
            --limit-tweets ${{ vars.BLUESKY_POSTS_PER_RUN || '1' }} \
            --limit-replies ${{ vars.BLUESKY_REPLIES_PER_RUN || '1' }}

      - name: Commit posted status via PR
        if: always()
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add agent/outputs/
          if git diff --staged --quiet; then
            echo "No changes to commit"
            exit 0
          fi
          BRANCH="bot/posted-$(date -u +%Y%m%d-%H%M%S)"
          git checkout -b "$BRANCH"
          git commit -m "[Bot] Posted content"
          git push -u origin "$BRANCH"
          PR_URL=$(gh pr create --title "[Bot] Posted content" --body "Automated: move posted files to archived directory." --head "$BRANCH")
          for i in 1 2 3; do
            gh pr merge "$PR_URL" --merge --delete-branch && break
            echo "Merge attempt $i failed (base branch modified?), retrying in 5s..."
            sleep 5
          done