name: Process Outputs

# Security: All actions pinned to commit SHAs to prevent tag hijacking attacks.
# Update SHAs manually when upgrading action versions.
#
# Posts pending content via integrations
# Runs every 2 hours, posts 1 item per run to avoid rate limits

on:
  schedule:
    - cron: '*/28 13-23 * * *'  # ~Every 28 min, 08:00-18:59 US Eastern (UTC-5)
    - cron: '*/28 0-3 * * *'    # ~Every 28 min, 19:00-22:59 US Eastern (UTC-5)
  workflow_dispatch:

jobs:
  process:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
    env:
      X_API_KEY: ${{ secrets.X_API_KEY }}
      X_API_KEY_SECRET: ${{ secrets.X_API_KEY_SECRET }}
      X_ACCESS_TOKEN: ${{ secrets.X_ACCESS_TOKEN }}
      X_ACCESS_TOKEN_SECRET: ${{ secrets.X_ACCESS_TOKEN_SECRET }}
      X_MAX_TWEET_LENGTH: ${{ vars.X_MAX_TWEET_LENGTH || '25000' }}
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6

      - name: Post to X
        run: |
          pip install -q -r agent/integrations/x/requirements.txt
          python agent/integrations/x/post.py --limit-tweets ${{ vars.X_TWEETS_PER_RUN || '3' }} --limit-replies ${{ vars.X_REPLIES_PER_RUN || '3' }}

      - name: Commit posted status via PR
        if: always()
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add agent/outputs/
          if git diff --staged --quiet; then
            echo "No changes to commit"
            exit 0
          fi
          BRANCH="bot/posted-$(date -u +%Y%m%d-%H%M%S)"
          git checkout -b "$BRANCH"
          git commit -m "[Bot] Posted content"
          git push -u origin "$BRANCH"
          PR_URL=$(gh pr create --title "[Bot] Posted content" --body "Automated: move posted files to archived directory." --head "$BRANCH")
          for i in 1 2 3; do
            gh pr merge "$PR_URL" --merge --delete-branch && break
            echo "Merge attempt $i failed (base branch modified?), retrying in 5s..."
            sleep 5
          done