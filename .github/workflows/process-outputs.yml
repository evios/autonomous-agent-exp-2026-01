name: Process Outputs

# Security: All actions pinned to commit SHAs to prevent tag hijacking attacks.
# Update SHAs manually when upgrading action versions.
#
# Posts pending content via integrations
# Runs every 2 hours, posts 1 item per run to avoid rate limits

on:
  schedule:
    - cron: '18 6,8,10,12,14,16,18,20,22 * * *'  # Every 2h, 06:18-22:18 UTC
  workflow_dispatch:

jobs:
  process:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    env:
      X_API_KEY: ${{ vars.X_API_KEY }}
      X_API_KEY_SECRET: ${{ secrets.X_API_KEY_SECRET }}
      X_ACCESS_TOKEN: ${{ secrets.X_ACCESS_TOKEN }}
      X_ACCESS_TOKEN_SECRET: ${{ secrets.X_ACCESS_TOKEN_SECRET }}
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6

      - name: Post to X
        run: |
          pip install -q -r agent/integrations/x/requirements.txt
          python agent/integrations/x/post.py --limit 1

      - name: Commit posted status
        if: always()
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add agent/outputs/
          git diff --staged --quiet || git commit -m "[Bot] Posted content"
          git push || true